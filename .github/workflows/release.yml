name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build plugin
        run: pnpm run build

      - name: Create release package
        run: |
          mkdir -p release/SearchPlus
          cp main.js manifest.json styles.css release/SearchPlus/
          cp README.md README_CN.md LICENSE release/

          # Create installation guide
          cat > release/INSTALL.md << 'EOF'
          # Installation Guide / å®‰è£…æŒ‡å—

          ## Method 1: Using Complete Package (Recommended) / æ–¹å¼1ï¼šä½¿ç”¨å®Œæ•´åŽ‹ç¼©åŒ…ï¼ˆæŽ¨èï¼‰

          ### English
          1. Download `SearchPlus-v*.zip` from GitHub Releases
          2. Extract the SearchPlus folder to your Obsidian plugins directory:
             - Windows: `%APPDATA%\Obsidian\plugins\`
             - macOS: `~/Library/Application Support/obsidian/plugins/`
             - Linux: `~/.config/obsidian/plugins/`
          3. Enable the plugin in Obsidian Settings > Community Plugins

          ### ä¸­æ–‡
          1. ä»Ž GitHub Releases ä¸‹è½½ `SearchPlus-v*.zip` æ–‡ä»¶
          2. å°† SearchPlus æ–‡ä»¶å¤¹è§£åŽ‹åˆ° Obsidian æ’ä»¶ç›®å½•ï¼š
             - Windows: `%APPDATA%\Obsidian\plugins\`
             - macOS: `~/Library/Application Support/obsidian/plugins/`
             - Linux: `~/.config/obsidian/plugins/`
          3. åœ¨ Obsidian è®¾ç½® > ç¬¬ä¸‰æ–¹æ’ä»¶ä¸­å¯ç”¨æ’ä»¶

          ## Method 2: Manual Installation with Individual Files / æ–¹å¼2ï¼šä½¿ç”¨å•ç‹¬æ–‡ä»¶æ‰‹åŠ¨å®‰è£…

          ### English
          1. Create a new folder named `search-plus` in your Obsidian plugins directory
          2. Download these three files from GitHub Releases:
             - `main.js`
             - `manifest.json` 
             - `styles.css`
          3. Place all three files in the `search-plus` folder
          4. Enable the plugin in Obsidian Settings > Community Plugins

          ### ä¸­æ–‡
          1. åœ¨ Obsidian æ’ä»¶ç›®å½•ä¸­åˆ›å»ºåä¸º `search-plus` çš„æ–°æ–‡ä»¶å¤¹
          2. ä»Ž GitHub Releases ä¸‹è½½è¿™ä¸‰ä¸ªæ–‡ä»¶ï¼š
             - `main.js`
             - `manifest.json`
             - `styles.css`
          3. å°†è¿™ä¸‰ä¸ªæ–‡ä»¶æ”¾å…¥ `search-plus` æ–‡ä»¶å¤¹ä¸­
          4. åœ¨ Obsidian è®¾ç½® > ç¬¬ä¸‰æ–¹æ’ä»¶ä¸­å¯ç”¨æ’ä»¶

          ## Plugin Directory Location / æ’ä»¶ç›®å½•ä½ç½®
          - Windows: `%APPDATA%\Obsidian\plugins\search-plus\`
          - macOS: `~/Library/Application Support/obsidian/plugins/search-plus/`
          - Linux: `~/.config/obsidian/plugins/search-plus/`
          EOF

      - name: Get tag version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            echo "## Changes since $PREVIOUS_TAG" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "CHANGELOG=Initial release" >> $GITHUB_OUTPUT
          fi

      - name: Create release archive
        run: |
          cd release
          zip -r SearchPlus-${{ steps.get_version.outputs.VERSION }}.zip SearchPlus/ INSTALL.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: SearchPlus ${{ steps.get_version.outputs.VERSION }}
          body: |
            # SearchPlus ${{ steps.get_version.outputs.VERSION }}

            ## ðŸ“¦ Download / ä¸‹è½½

            ### æ–¹å¼1ï¼šå®Œæ•´åŽ‹ç¼©åŒ… (æŽ¨è) / Method 1: Complete Package (Recommended)
            Download `SearchPlus-${{ steps.get_version.outputs.VERSION }}.zip` and follow the installation guide.
            ä¸‹è½½ `SearchPlus-${{ steps.get_version.outputs.VERSION }}.zip` å¹¶æŒ‰ç…§å®‰è£…æŒ‡å—æ“ä½œã€‚

            ### æ–¹å¼2ï¼šå•ç‹¬æ–‡ä»¶ / Method 2: Individual Files  
            Download individual files if you prefer manual installation:
            å¦‚æžœä½ å–œæ¬¢æ‰‹åŠ¨å®‰è£…ï¼Œå¯ä»¥ä¸‹è½½å•ç‹¬æ–‡ä»¶ï¼š
            - `main.js` - Plugin main file / æ’ä»¶ä¸»æ–‡ä»¶
            - `manifest.json` - Plugin manifest / æ’ä»¶æ¸…å•
            - `styles.css` - Plugin styles / æ’ä»¶æ ·å¼

            ## ðŸš€ What's New / æ–°åŠŸèƒ½

            ${{ steps.changelog.outputs.CHANGELOG }}

            ## ðŸ”§ Installation / å®‰è£…

            See `INSTALL.md` in the download package for detailed installation instructions.
            è¯¦ç»†å®‰è£…è¯´æ˜Žè¯·æŸ¥çœ‹ä¸‹è½½åŒ…ä¸­çš„ `INSTALL.md` æ–‡ä»¶ã€‚

            ## ðŸ“š Documentation / æ–‡æ¡£

            - [English README](README.md)
            - [ä¸­æ–‡æ–‡æ¡£](README_CN.md)

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}
          files: |
            release/SearchPlus-${{ steps.get_version.outputs.VERSION }}.zip
            release/INSTALL.md
            main.js
            manifest.json
            styles.css
            README.md
            README_CN.md
            LICENSE
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release notes
        run: |
          cat > release/RELEASE_NOTES.md << EOF
          # Release Notes - ${{ steps.get_version.outputs.VERSION }}

          ## English
          ${{ steps.changelog.outputs.CHANGELOG }}

          ## ä¸­æ–‡
          ${{ steps.changelog.outputs.CHANGELOG }}

          ## Files Included / åŒ…å«æ–‡ä»¶
          - \`main.js\` - Plugin main file / æ’ä»¶ä¸»æ–‡ä»¶
          - \`manifest.json\` - Plugin manifest / æ’ä»¶æ¸…å•
          - \`styles.css\` - Plugin styles / æ’ä»¶æ ·å¼
          - \`README.md\` - English documentation / è‹±æ–‡æ–‡æ¡£
          - \`README_CN.md\` - Chinese documentation / ä¸­æ–‡æ–‡æ¡£
          - \`LICENSE\` - License file / è®¸å¯è¯æ–‡ä»¶
          - \`INSTALL.md\` - Installation guide / å®‰è£…æŒ‡å—
          EOF
