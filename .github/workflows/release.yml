name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build plugin
        run: npm run build

      - name: Create release package
        run: |
          mkdir -p release/SearchPlus
          cp main.js manifest.json styles.css release/SearchPlus/
          cp README.md README_CN.md LICENSE release/

          # Create installation guide
          cat > release/INSTALL.md << 'EOF'
          # Installation Guide / å®‰è£…æŒ‡å—

          ## English
          1. Download the latest release from GitHub
          2. Extract the SearchPlus folder to your Obsidian plugins directory:
             - Windows: `%APPDATA%\Obsidian\plugins\`
             - macOS: `~/Library/Application Support/obsidian/plugins/`
             - Linux: `~/.config/obsidian/plugins/`
          3. Enable the plugin in Obsidian Settings > Community Plugins

          ## ä¸­æ–‡
          1. ä»Ž GitHub ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
          2. å°† SearchPlus æ–‡ä»¶å¤¹è§£åŽ‹åˆ° Obsidian æ’ä»¶ç›®å½•ï¼š
             - Windows: `%APPDATA%\Obsidian\plugins\`
             - macOS: `~/Library/Application Support/obsidian/plugins/`
             - Linux: `~/.config/obsidian/plugins/`
          3. åœ¨ Obsidian è®¾ç½® > ç¬¬ä¸‰æ–¹æ’ä»¶ä¸­å¯ç”¨æ’ä»¶
          EOF

      - name: Get tag version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            echo "## Changes since $PREVIOUS_TAG" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "CHANGELOG=Initial release" >> $GITHUB_OUTPUT
          fi

      - name: Create release archive
        run: |
          cd release
          zip -r SearchPlus-${{ steps.get_version.outputs.VERSION }}.zip SearchPlus/ INSTALL.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: SearchPlus ${{ steps.get_version.outputs.VERSION }}
          body: |
            # SearchPlus ${{ steps.get_version.outputs.VERSION }}

            ## ðŸ“¦ Download / ä¸‹è½½

            Download `SearchPlus-${{ steps.get_version.outputs.VERSION }}.zip` and follow the installation guide.
            ä¸‹è½½ `SearchPlus-${{ steps.get_version.outputs.VERSION }}.zip` å¹¶æŒ‰ç…§å®‰è£…æŒ‡å—æ“ä½œã€‚

            ## ðŸš€ What's New / æ–°åŠŸèƒ½

            ${{ steps.changelog.outputs.CHANGELOG }}

            ## ðŸ”§ Installation / å®‰è£…

            See `INSTALL.md` in the download package for detailed installation instructions.
            è¯¦ç»†å®‰è£…è¯´æ˜Žè¯·æŸ¥çœ‹ä¸‹è½½åŒ…ä¸­çš„ `INSTALL.md` æ–‡ä»¶ã€‚

            ## ðŸ“š Documentation / æ–‡æ¡£

            - [English README](README.md)
            - [ä¸­æ–‡æ–‡æ¡£](README_CN.md)

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}
          files: |
            release/SearchPlus-${{ steps.get_version.outputs.VERSION }}.zip
            release/INSTALL.md
            README.md
            README_CN.md
            LICENSE
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release notes
        run: |
          cat > release/RELEASE_NOTES.md << EOF
          # Release Notes - ${{ steps.get_version.outputs.VERSION }}

          ## English
          ${{ steps.changelog.outputs.CHANGELOG }}

          ## ä¸­æ–‡
          ${{ steps.changelog.outputs.CHANGELOG }}

          ## Files Included / åŒ…å«æ–‡ä»¶
          - \`main.js\` - Plugin main file / æ’ä»¶ä¸»æ–‡ä»¶
          - \`manifest.json\` - Plugin manifest / æ’ä»¶æ¸…å•
          - \`styles.css\` - Plugin styles / æ’ä»¶æ ·å¼
          - \`README.md\` - English documentation / è‹±æ–‡æ–‡æ¡£
          - \`README_CN.md\` - Chinese documentation / ä¸­æ–‡æ–‡æ¡£
          - \`LICENSE\` - License file / è®¸å¯è¯æ–‡ä»¶
          - \`INSTALL.md\` - Installation guide / å®‰è£…æŒ‡å—
          EOF
